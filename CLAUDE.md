# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

plorp is a workflow automation layer that sits on top of TaskWarrior 3.x and Obsidian. It is NOT a task manager or note-taking app itself, but rather a bridge that connects TaskWarrior and Obsidian through three core workflows:

1. **Inbox workflow** - Email → Markdown → TaskWarrior/Obsidian
2. **Daily ritual** - Generate daily notes with tasks from TaskWarrior
3. **Review workflow** - End-of-day processing of incomplete tasks

The daily note serves as the primary interface. Users work in markdown files (daily notes, inbox files), and plorp syncs these with TaskWarrior.

## Core Architecture

### High-Level Design

- **plorp**: Python CLI scripts that orchestrate workflows
- **TaskWarrior 3.4.1**: Task storage (SQLite via TaskChampion)
- **Obsidian**: Note storage (markdown files in vault/)

### Technology Stack

- **Language**: Python 3.8+
- **Key Libraries**: PyYAML, click, rich
- **External Dependencies**: TaskWarrior CLI (must be installed)

### Project Structure

```
plorp/
├── src/plorp/
│   ├── cli.py              # CLI command routing
│   ├── config.py           # Configuration management
│   ├── workflows/          # Core workflow implementations
│   │   ├── daily.py        # Daily start/review
│   │   ├── inbox.py        # Inbox processing
│   │   └── notes.py        # Note creation/linking
│   ├── integrations/       # External tool integrations
│   │   ├── taskwarrior.py  # TaskWarrior CLI wrapper
│   │   └── obsidian.py     # Obsidian file operations
│   ├── parsers/            # Data parsing
│   │   ├── markdown.py     # Markdown parsing
│   │   └── frontmatter.py  # YAML front matter
│   └── utils/              # Utilities
└── scripts/                # External scripts
    └── email_to_inbox.py   # Email capture (cron)
```

## TaskWarrior Integration Strategy

### Key Principle: CLI for Writes, Optional Direct SQLite for Reads

**TaskWarrior 3.x uses SQLite** (`~/.task/taskchampion.sqlite3`) instead of flat files like 2.x.

**For Write Operations** (ALWAYS):
- Use `subprocess` to call the `task` CLI
- This respects TaskWarrior's transaction model, hooks, and sync protocol
- Examples: `task add`, `task <uuid> done`, `task <uuid> modify`

**For Read Operations** (Recommended):
- Primary: Use `task export` via subprocess (returns JSON)
- Advanced: Direct SQLite queries for performance-critical reads (read-only)

**NEVER write directly to SQLite** - this bypasses TaskChampion's operation log and will corrupt the database.

### Important TaskWarrior Details

- **UUIDs are stable** across sync; use them for task references, not numeric IDs
- **Filter syntax**: `status:pending`, `due:today`, `due.before:today`, `project:home`, `+tag`
- **Export format**: `task <filter> export` returns JSON array of task objects
- **Date fields**: Stored as ISO 8601 format (e.g., `20251007T000000Z`)

## Obsidian Integration

### Vault Structure

```
vault/
├── daily/          # Daily notes (generated by plorp)
├── inbox/          # Monthly inbox files (YYYY-MM.md)
├── notes/          # General notes
└── projects/       # Project notes
```

### File Format Conventions

**Daily notes** (`vault/daily/YYYY-MM-DD.md`):
- YAML front matter with date, type, plorp_version
- Markdown checkboxes with task metadata in parentheses including UUID
- Format: `- [ ] Description (project: X, due: Y, uuid: Z)`

**Inbox files** (`vault/inbox/YYYY-MM.md`):
- Two sections: "## Unprocessed" and "## Processed"
- Unprocessed items are markdown checkboxes
- Processing moves items to "Processed" section with action annotation

**Notes** (`vault/notes/*.md`):
- YAML front matter can include `tasks: [uuid1, uuid2]` for linking
- TaskWarrior annotations link back: `task <uuid> annotate "Note: vault/notes/file.md"`

## Core Workflows

### Workflow 1: Daily Start (`plorp start`)
1. Query TaskWarrior for overdue, due today, and recurring tasks
2. Generate `vault/daily/YYYY-MM-DD.md` with tasks as checkboxes
3. Print path to user

### Workflow 2: Review (`plorp review`)
1. Parse today's daily note for unchecked tasks
2. For each task, show details and linked notes
3. Interactive prompts: done, defer, change priority, skip, delete
4. Update TaskWarrior based on decisions
5. Append review summary to daily note

### Workflow 3: Inbox Processing (`plorp inbox process`)
1. Read current month's inbox file
2. For each unprocessed item, prompt: create task, create note, discard, skip
3. Create tasks in TaskWarrior or notes in Obsidian as directed
4. Mark items as processed in inbox file

## Development Commands

**Setup**:
```bash
python3 -m venv venv
source venv/bin/activate
pip install -e .
```

**Testing**:
```bash
pytest tests/ -v
pytest tests/ --cov=src/plorp --cov-report=html
```

**Formatting**:
```bash
black src/ tests/
```

**Running plorp**:
```bash
plorp start
plorp review
plorp inbox process
plorp note "Title" --task <uuid>
plorp link <uuid> <note-path>
```

## Design Principles

### Simplicity First
- No custom database
- No custom codes (m1, p1, etc.)
- Python scripts that call `task` CLI, not complex abstractions
- plorp is stateless - just reads/writes to TaskWarrior and Obsidian

### Markdown-Centric
- Daily notes, inbox files, and review annotations all in markdown
- plorp parses markdown ↔ TaskWarrior

### UUID-Based Linking
- Tasks reference notes via TaskWarrior annotations
- Notes reference tasks via YAML front matter `tasks:` field
- Bidirectional linking maintained by plorp helper commands

## Configuration

**Location**: `~/.config/plorp/config.yaml` or `$XDG_CONFIG_HOME/plorp/config.yaml`

**Default config**:
```yaml
vault_path: ~/vault
taskwarrior_data: ~/.task
inbox_email: null
default_editor: vim
```

## Implementation Status

This is a **planning repository** - implementation has not started. The specification files in `Docs/` are:
- `plorp_SPEC.md` - Complete specification
- `plorp_ARCHITECTURE.md` - Technical implementation details
- `plorp_IMPLEMENTATION_PLAN.md` - Phase-by-phase build plan
- `plorp_TASKWARRIOR_INTEGRATION.md` - TaskWarrior 3.x integration guide
- `plorp_PRIOR_VERSION_NOTES.md` - Reference notes from previous iteration (for context only)

When implementing, follow the phase plan in `plorp_IMPLEMENTATION_PLAN.md`:
- Phase 0: Setup (project structure)
- Phase 1: Core Daily Workflow (`plorp start`)
- Phase 2: Review Workflow (`plorp review`)
- Phase 3: Inbox Workflow (`plorp inbox process`)
- Phase 4: Note Linking (`plorp note`, `plorp link`)
- Phase 5: Polish & Documentation

## Key Constraints

- Require Python 3.8+
- Require TaskWarrior 3.4.1+ to be installed
- Use subprocess for all TaskWarrior write operations
- Never write directly to TaskWarrior's SQLite database
- Parse markdown defensively (users may edit files manually)
- Handle missing tasks/files gracefully
