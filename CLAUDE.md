# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

plorp is a workflow automation layer that sits on top of TaskWarrior 3.x and Obsidian. It is NOT a task manager or note-taking app itself, but rather a bridge that connects TaskWarrior and Obsidian through three core workflows:

1. **Inbox workflow** - Email → Markdown → TaskWarrior/Obsidian
2. **Daily ritual** - Generate daily notes with tasks from TaskWarrior
3. **Review workflow** - End-of-day processing of incomplete tasks

The daily note serves as the primary interface. Users work in markdown files (daily notes, inbox files), and plorp syncs these with TaskWarrior.

## Working with This Codebase

### Superpowers Skills System

**This project does NOT use the Superpowers skills system.**

plorp has its own robust documentation and workflow system:
- **PM_HANDOFF.md** - Session history and current state (source of truth)
- **Sprint specifications** - Detailed implementation patterns with Q&A
- **MCP_ARCHITECTURE_GUIDE.md** - Architectural patterns (TypedDict, pure functions, three-tier)
- **PM_INSTANCE_INSTRUCTIONS.md** - Mandatory workflows for PM instances
- **This file (CLAUDE.md)** - State Synchronization pattern, design principles

**If you see a session-start-hook about Superpowers:**
- Ignore it for this project
- Do not use skills-search
- Do not create skills from this codebase
- Follow our existing PM/handoff system instead

**Why:** Superpowers is designed for pattern discovery during active development. We've already encoded our patterns in documentation and have a working PM/Lead Engineer handoff system that serves the same purpose.

## Core Architecture

### High-Level Design

- **plorp**: Python CLI scripts that orchestrate workflows
- **TaskWarrior 3.4.1**: Task storage (SQLite via TaskChampion)
- **Obsidian**: Note storage (markdown files in vault/)

### Technology Stack

- **Language**: Python 3.8+
- **Key Libraries**: PyYAML, click, rich
- **External Dependencies**: TaskWarrior CLI (must be installed)

### Project Structure

```
plorp/
├── src/plorp/
│   ├── cli.py              # CLI command routing
│   ├── config.py           # Configuration management
│   ├── workflows/          # Core workflow implementations
│   │   ├── daily.py        # Daily start/review
│   │   ├── inbox.py        # Inbox processing
│   │   └── notes.py        # Note creation/linking
│   ├── integrations/       # External tool integrations
│   │   ├── taskwarrior.py  # TaskWarrior CLI wrapper
│   │   └── obsidian.py     # Obsidian file operations
│   ├── parsers/            # Data parsing
│   │   ├── markdown.py     # Markdown parsing
│   │   └── frontmatter.py  # YAML front matter
│   └── utils/              # Utilities
└── scripts/                # External scripts
    └── email_to_inbox.py   # Email capture (cron)
```

## TaskWarrior Integration Strategy

### Key Principle: CLI for Writes, Optional Direct SQLite for Reads

**TaskWarrior 3.x uses SQLite** (`~/.task/taskchampion.sqlite3`) instead of flat files like 2.x.

**For Write Operations** (ALWAYS):
- Use `subprocess` to call the `task` CLI
- This respects TaskWarrior's transaction model, hooks, and sync protocol
- Examples: `task add`, `task <uuid> done`, `task <uuid> modify`

**For Read Operations** (Recommended):
- Primary: Use `task export` via subprocess (returns JSON)
- Advanced: Direct SQLite queries for performance-critical reads (read-only)

**NEVER write directly to SQLite** - this bypasses TaskChampion's operation log and will corrupt the database.

### Important TaskWarrior Details

- **UUIDs are stable** across sync; use them for task references, not numeric IDs
- **Filter syntax**: `status:pending`, `due:today`, `due.before:today`, `project:home`, `+tag`
- **Export format**: `task <filter> export` returns JSON array of task objects
- **Date fields**: Stored as ISO 8601 format (e.g., `20251007T000000Z`)

## Obsidian Integration

### Vault Structure

```
vault/
├── daily/          # Daily notes (generated by plorp)
├── inbox/          # Monthly inbox files (YYYY-MM.md)
├── notes/          # General notes
└── projects/       # Project notes
```

### File Format Conventions

**Daily notes** (`vault/daily/YYYY-MM-DD.md`):
- YAML front matter with date, type, plorp_version
- Markdown checkboxes with task metadata in parentheses including UUID
- Format: `- [ ] Description (project: X, due: Y, uuid: Z)`

**Inbox files** (`vault/inbox/YYYY-MM.md`):
- Two sections: "## Unprocessed" and "## Processed"
- Unprocessed items are markdown checkboxes
- Processing moves items to "Processed" section with action annotation

**Notes** (`vault/notes/*.md`):
- YAML front matter can include `tasks: [uuid1, uuid2]` for linking
- TaskWarrior annotations link back: `task <uuid> annotate "Note: vault/notes/file.md"`

## Core Workflows

### Workflow 1: Daily Start (`plorp start`)
1. Query TaskWarrior for overdue, due today, and recurring tasks
2. Generate `vault/daily/YYYY-MM-DD.md` with tasks as checkboxes
3. Print path to user

### Workflow 2: Review (`plorp review`)
1. Parse today's daily note for unchecked tasks
2. For each task, show details and linked notes
3. Interactive prompts: done, defer, change priority, skip, delete
4. Update TaskWarrior based on decisions
5. Append review summary to daily note

### Workflow 3: Inbox - Email Fetch (`plorp inbox fetch`)
**Sprint 9.2** - Automated email capture from Gmail via IMAP

1. Connect to Gmail using IMAP (App Password authentication)
2. Fetch unread emails from INBOX or custom label
3. Convert email body to markdown bullets (no subject, no metadata)
4. Append bullets to monthly inbox file (`vault/inbox/YYYY-MM.md`)
5. Mark emails as SEEN in Gmail to avoid re-fetch

**Configuration** (`~/.config/plorp/config.yaml`):
```yaml
email:
  enabled: true
  imap_server: imap.gmail.com
  imap_port: 993
  username: your@gmail.com
  password: "app_password_here"  # Gmail App Password
  inbox_label: "plorp"  # Optional: only fetch from this label
  fetch_limit: 20
```

**Usage:**
```bash
# Manual fetch
plorp inbox fetch

# With options
plorp inbox fetch --limit 10 --label work --verbose

# Dry run (preview without appending)
plorp inbox fetch --dry-run

# Cron job (every 15 minutes)
*/15 * * * * cd /path/to/plorp && .venv/bin/plorp inbox fetch
```

**Gmail App Password Setup:**
1. Enable 2FA on Gmail account
2. Go to https://myaccount.google.com/apppasswords
3. Generate password for "plorp"
4. Copy 16-char password to config file

### Workflow 4: Inbox - Process Items (`plorp inbox process`)
1. Read current month's inbox file
2. For each unprocessed item, prompt: create task, create note, discard, skip
3. Create tasks in TaskWarrior or notes in Obsidian as directed
4. Mark items as processed in inbox file

## Quick Task Queries

**Sprint 9.1** introduced instant task queries to bypass slow MCP agent reasoning.

### Three-Tier Query Architecture

1. **CLI Commands** (<100ms) - Direct terminal access
   ```bash
   plorp tasks              # All pending tasks (default limit: 50)
   plorp tasks --urgent     # Only priority:H tasks
   plorp tasks --project work
   plorp tasks --due today
   plorp tasks --due overdue
   ```

2. **Slash Commands** (1-2s) - Claude Desktop fast access
   - `/tasks` - All pending tasks
   - `/urgent` - Urgent tasks only
   - `/today` - Tasks due today
   - `/overdue` - Overdue tasks
   - `/work-tasks` - Tasks in work project

3. **Natural Language** (5-8s) - Full reasoning when needed
   - "Show me urgent tasks in the API project due this week"

### CLI Options

**Filters:**
- `--urgent` - Priority:H tasks only
- `--important` - Priority:M tasks only
- `--project <name>` - Filter by project
- `--due <when>` - Filter by due date (today, tomorrow, overdue, week)
- `--limit <n>` - Limit results (default: 50)

**Output Formats:**
- `--format table` (default) - Rich table with emojis and colors
- `--format simple` - Plain text for scripts
- `--format json` - JSON output for programmatic use

**Examples:**
```bash
plorp tasks --urgent --project work
plorp tasks --due today --format json
plorp tasks --project home --limit 10
```

### Performance

- **CLI**: <100ms (subprocess to TaskWarrior)
- **Slash commands**: 1-2s (Claude Desktop overhead)
- **Natural language**: 5-8s (agent reasoning + tool calls)

Use the appropriate tier based on query complexity.

## Development Commands

**Setup**:
```bash
python3 -m venv venv
source venv/bin/activate
pip install -e .
```

**Testing**:
```bash
pytest tests/ -v
pytest tests/ --cov=src/plorp --cov-report=html
```

**Formatting**:
```bash
black src/ tests/
```

**Running plorp**:
```bash
plorp start
plorp review
plorp inbox fetch       # Fetch emails from Gmail
plorp inbox process     # Process inbox items
plorp note "Title" --task <uuid>
plorp link <uuid> <note-path>
```

## Version Management

**Version Numbering (Semantic Versioning):**
- Format: `MAJOR.MINOR.PATCH` (e.g., `1.4.0`)
- **Major sprints** (new features, workflows): Increment MINOR version (1.3.0 → 1.4.0)
- **Minor sprints** (polish, fixes, small enhancements): Increment PATCH version (1.4.0 → 1.4.1)

**Lead Engineer Responsibilities:**
- Update version in **both** files when completing a sprint:
  - `src/plorp/__init__.py` - `__version__` variable
  - `pyproject.toml` - `version` field
- Ensure both files have matching version numbers
- Include version bump in final sprint commit

**PM Instance Responsibilities:**
- **Verify version was incremented** before signing off on sprint completion
- Check that both `__init__.py` and `pyproject.toml` match
- Confirm version number follows convention (MINOR for major sprint, PATCH for minor sprint)

**Version History:**
- v1.0.0 - Sprint 0-2 (Initial workflows)
- v1.1.0 - Sprint 3-5 (Inbox processing)
- v1.2.0 - Sprint 6 (MCP integration)
- v1.3.0 - Sprint 7 (/process workflow)
- v1.4.0 - Sprint 8 (Project management with Obsidian Bases)
- v1.5.0 - Sprint 9 (General note management & vault interface)
- v1.5.1 - Sprint 9.1 (Fast task queries - CLI & slash commands)
- v1.5.2 - Sprint 9.2 (Email inbox capture via Gmail IMAP)

## Design Principles

### Simplicity First
- No custom database
- No custom codes (m1, p1, etc.)
- Python scripts that call `task` CLI, not complex abstractions
- plorp is stateless - just reads/writes to TaskWarrior and Obsidian

### Markdown-Centric
- Daily notes, inbox files, and review annotations all in markdown
- plorp parses markdown ↔ TaskWarrior

### UUID-Based Linking
- Tasks reference notes via TaskWarrior annotations
- Notes reference tasks via YAML front matter `tasks:` field
- Bidirectional linking maintained by plorp helper commands

### State Synchronization (Critical Pattern)

**Core Principle:** Every plorp operation that modifies TaskWarrior **must** update all related Obsidian surfaces.

plorp is a **bridge** between two systems (TaskWarrior and Obsidian). When state changes in one system, it must propagate to the other. This is not optional - it's a fundamental architectural requirement.

**The Pattern:**

```python
# ✅ CORRECT - Full state sync
def mark_task_done_via_review(uuid: str):
    # 1. Update TaskWarrior
    mark_done(uuid)

    # 2. Update ALL related Obsidian surfaces
    remove_task_from_projects(uuid)     # Update project frontmatter
    update_daily_note_checkbox(uuid)    # Update daily note if present

    # State is consistent across both systems ✅

# ❌ WRONG - Partial update (creates orphaned data)
def mark_task_done_via_review(uuid: str):
    mark_done(uuid)  # Only TaskWarrior updated
    # Project still references deleted task ❌
    # Daily note still shows task as pending ❌
```

**Examples of Required Sync:**

| Operation | TaskWarrior Change | Required Obsidian Updates |
|-----------|-------------------|---------------------------|
| `/review` marks task done | `task <uuid> done` | Remove UUID from project `task_uuids`, update daily note checkbox |
| `/review` deletes task | `task <uuid> delete` | Remove UUID from ALL projects, remove from daily notes |
| `create_task_in_project()` | `task add ...` | Add UUID to project frontmatter |
| Change task project | `task <uuid> modify project:X` | Remove from old project, add to new project |
| Task priority change | `task <uuid> modify priority:H` | Update daily note metadata display |

**Anti-Patterns to Avoid:**

1. **Orphaned UUIDs** - TaskWarrior task deleted, but UUID remains in project frontmatter
   ```yaml
   # ❌ Project frontmatter after task deleted
   task_uuids:
     - abc-123  # This task no longer exists!
   ```

2. **Stale Checkbox State** - User checks box in Obsidian, TaskWarrior not updated
   ```markdown
   # ❌ Daily note
   - [x] Buy groceries (uuid: abc-123)
   # TaskWarrior still shows as pending!
   ```

3. **Missing Task References** - Task created in project, but project doesn't know about it
   ```python
   # ❌ Created task but forgot to update project
   uuid = create_task(description="Fix bug", project="work.api-rewrite")
   # task_uuids not updated in project frontmatter
   ```

**Why This Matters:**

- **Data Integrity** - Both systems must reflect the same truth
- **User Trust** - Inconsistent state destroys confidence in the system
- **Workflow Correctness** - Other operations depend on accurate state
- **No Manual Fixes** - Users should never need to edit frontmatter by hand to fix sync issues

**Implementation Guidelines:**

1. **Every TaskWarrior write operation gets a sync partner:**
   - `mark_done()` → `remove_from_projects()`
   - `create_task()` → `add_to_project()`
   - `modify_task()` → `update_related_notes()`

2. **Use helper functions to enforce pattern:**
   ```python
   def create_task_with_sync(description, project=None, ...):
       """Create task and update all related surfaces."""
       uuid = create_task(description, project, ...)
       if project:
           add_task_to_project_frontmatter(project, uuid)
       return uuid
   ```

3. **Test both sides:**
   ```python
   def test_review_marks_done_syncs_project():
       # Create task in project
       uuid = create_task_in_project(...)

       # Mark done via review
       mark_task_done_via_review(uuid)

       # Verify BOTH sides updated
       assert get_task_status(uuid) == "completed"  # TaskWarrior
       assert uuid not in get_project_task_uuids()  # Obsidian
   ```

4. **Document sync behavior in docstrings:**
   ```python
   def mark_done(uuid: str):
       """
       Mark task as complete in TaskWarrior.

       IMPORTANT: This function ONLY updates TaskWarrior.
       Caller must also update related Obsidian surfaces:
       - Remove UUID from project frontmatter
       - Update daily note checkboxes

       See: remove_task_from_projects()
       """
   ```

**External Changes (Outside plorp):**

When TaskWarrior is modified by external tools (CLI, mobile apps), plorp cannot automatically sync because it's not running. Future solutions:

- **TaskWarrior Hooks** (Sprint 10+) - Install hooks that call plorp sync handlers
- **Reconciliation Command** - `plorp reconcile` to detect and fix drift
- **Server Mode** (Future) - Long-running plorp daemon that monitors TaskWarrior

**For Sprint 8.5 and beyond:** Review all TaskWarrior modification points and ensure Obsidian sync is present.

## Configuration

**Location**: `~/.config/plorp/config.yaml` or `$XDG_CONFIG_HOME/plorp/config.yaml`

**Default config**:
```yaml
vault_path: /Users/jsd/vault
taskwarrior_data: ~/.task
inbox_email: null
default_editor: vim
```

**Note**: Configure vault location in `~/.config/plorp/config.yaml`.

## Implementation Status

**Sprint 0**: ✅ Complete - Project structure and test infrastructure in place

The specification files in `Docs/` are:
- `plorp_SPEC.md` - Complete specification
- `plorp_ARCHITECTURE.md` - Technical implementation details
- `plorp_IMPLEMENTATION_PLAN.md` - Phase-by-phase build plan
- `plorp_TASKWARRIOR_INTEGRATION.md` - TaskWarrior 3.x integration guide
- `plorp_PRIOR_VERSION_NOTES.md` - Reference notes from previous iteration (for context only)
- `VAULT_SETUP.md` - Obsidian vault configuration for development
- `sprints/` - Individual sprint specifications (SPRINT_0 through SPRINT_5)

When implementing, follow the phase plan in `plorp_IMPLEMENTATION_PLAN.md`:
- Phase 0: Setup (project structure)
- Phase 1: Core Daily Workflow (`plorp start`)
- Phase 2: Review Workflow (`plorp review`)
- Phase 3: Inbox Workflow (`plorp inbox process`)
- Phase 4: Note Linking (`plorp note`, `plorp link`)
- Phase 5: Polish & Documentation

## Key Constraints

- Require Python 3.8+
- Require TaskWarrior 3.4.1+ to be installed
- Use subprocess for all TaskWarrior write operations
- Never write directly to TaskWarrior's SQLite database
- Parse markdown defensively (users may edit files manually)
- Handle missing tasks/files gracefully

## Context Management

Claude Code instances have a 200,000 token context budget per session. Monitor usage via system warnings.

**Alert Protocol:**
- Alert user when remaining context drops below 120,000 tokens (~60% used)
- Proactively suggest checkpointing work or starting fresh session if needed
- User can request context status at any time

**When Low on Context:**
1. Complete current task if nearly done
2. Update PM_HANDOFF.md with session notes
3. Suggest user start new session to continue work
4. Avoid starting new complex tasks

**Context-Efficient Practices:**
- Use targeted file reads (offset/limit) for large files
- Prefer Grep over reading entire files when searching
- Use Task agent for multi-step searches
- Avoid unnecessary re-reads of large files
